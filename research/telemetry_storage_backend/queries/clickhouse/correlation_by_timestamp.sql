WITH span_buckets AS (SELECT service, toStartOfMinute(ts_start) AS time_bucket, uniq(span_id) AS span_count FROM telemetry.spans WHERE ts_start >= now() - INTERVAL 30 DAY GROUP BY service, toStartOfMinute(ts_start)), log_buckets AS (SELECT service, toStartOfMinute(ts) AS time_bucket, count() AS log_count FROM telemetry.logs WHERE ts >= now() - INTERVAL 30 DAY GROUP BY service, toStartOfMinute(ts)), metric_buckets AS (SELECT toStartOfMinute(ts) AS time_bucket, count() AS metric_count FROM telemetry.metrics WHERE ts >= now() - INTERVAL 30 DAY GROUP BY toStartOfMinute(ts)) SELECT s.service, s.time_bucket, s.span_count, coalesce(l.log_count,0) AS log_count, coalesce(m.metric_count,0) AS metric_count FROM span_buckets s LEFT JOIN log_buckets l ON s.service=l.service AND s.time_bucket=l.time_bucket LEFT JOIN metric_buckets m ON s.time_bucket=m.time_bucket ORDER BY (s.span_count+coalesce(l.log_count,0)+coalesce(m.metric_count,0)) DESC LIMIT 20
